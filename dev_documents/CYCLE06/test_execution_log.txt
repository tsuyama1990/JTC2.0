============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
testpaths: tests
plugins: cov-7.0.0, langsmith-0.7.6, anyio-4.12.1
collected 136 items

tests/integration/test_rag_flow.py ...                                   [  2%]
tests/uat/test_cycle05_uat.py ...                                        [  4%]
tests/uat/test_cycle06_uat.py ..                                         [  5%]
tests/uat/test_memory_safety.py ...                                      [  8%]
tests/uat/test_nemawashi_uat.py ..                                       [  9%]
tests/uat/test_uat_cycle01.py ...                                        [ 11%]
tests/uat/test_uat_cycle02.py .                                          [ 12%]
tests/uat/test_uat_cycle03.py ..                                         [ 13%]
tests/unit/domain_models/test_models.py ...........                      [ 22%]
tests/unit/domain_models/test_politics.py .....                          [ 25%]
tests/unit/domain_models/test_simulation_models.py .....                 [ 29%]
tests/unit/domain_models/test_transcript.py ...                          [ 31%]
tests/unit/test_builder_agent.py ...........                             [ 39%]
tests/unit/test_cli_input.py ...                                         [ 41%]
tests/unit/test_cli_scalability.py .                                     [ 42%]
tests/unit/test_config.py .......                                        [ 47%]
tests/unit/test_core.py ....                                             [ 50%]
tests/unit/test_core_graph.py .....                                      [ 54%]
tests/unit/test_cpo_agent.py ..                                          [ 55%]
tests/unit/test_domain_models.py .......                                 [ 61%]
tests/unit/test_file_service.py ...                                      [ 63%]
tests/unit/test_governance_agent.py F                                    [ 63%]
tests/unit/test_governance_memory.py ..                                  [ 65%]
tests/unit/test_ideator_agent.py ...                                     [ 67%]
tests/unit/test_metrics_logic.py .........                               [ 74%]
tests/unit/test_nemawashi.py ....                                        [ 77%]
tests/unit/test_rag.py .....                                             [ 80%]
tests/unit/test_rag_errors.py ....                                       [ 83%]
tests/unit/test_rag_refactored.py .                                      [ 84%]
tests/unit/test_simulation_integration.py ..                             [ 86%]
tests/unit/test_simulation_logic.py ........                             [ 91%]
tests/unit/test_tools.py ...                                             [ 94%]
tests/unit/test_ui.py .....                                              [ 97%]
tests/unit/test_v0_client.py ...                                         [100%]

=================================== FAILURES ===================================
_______________ TestGovernanceAgent.test_run_populates_ringi_sho _______________

self = <test_governance_agent.TestGovernanceAgent object at 0x7fddc54757c0>
mock_roi = <MagicMock name='calculate_roi' id='140590459416176'>
mock_payback = <MagicMock name='calculate_payback_period' id='140590459464416'>
mock_ltv = <MagicMock name='calculate_ltv' id='140590459468208'>
mock_search_cls = <MagicMock name='TavilySearch' id='140590459521072'>
mock_state = GlobalState(phase=<Phase.IDEATION: 'ideation'>, topic='AI Productivity Tool', generated_ideas=None, selected_idea=None...Network(stakeholders=[Stakeholder(name='CEO', initial_support=0.8, stubbornness=0.1)], matrix=[[1.0]]), ringi_sho=None)

    @patch("src.agents.governance.TavilySearch")
    @patch("src.core.metrics.calculate_ltv")
    @patch("src.core.metrics.calculate_payback_period")
    @patch("src.core.metrics.calculate_roi")
    def test_run_populates_ringi_sho(
        self,
        mock_roi: MagicMock,
        mock_payback: MagicMock,
        mock_ltv: MagicMock,
        mock_search_cls: MagicMock,
        mock_state: GlobalState
    ) -> None:
        """Test that run method populates RingiSho in the returned dictionary."""
        # Setup mocks
        mock_search_instance = mock_search_cls.return_value
        mock_search_instance.safe_search.return_value = "CAC: $500\nChurn: 5%\nARPU: $100"

        mock_ltv.return_value = 2000.0
        mock_payback.return_value = 5.0
        mock_roi.return_value = 4.0

        # Mock File Service
        mock_file_service = MagicMock(spec=FileService)

        agent = GovernanceAgent(file_service=mock_file_service)

        # Check `src/core/llm.py` later. For now, let's assume it runs.

        with patch("src.agents.governance.get_llm") as mock_llm_factory:
            mock_llm = mock_llm_factory.return_value

            # Mock LLM responses (called twice: financials, then ringi-sho)
            mock_msg_fin = MagicMock()
            mock_msg_fin.content = '{"cac": 500.0, "arpu": 100.0, "churn_rate": 0.05}'

            mock_msg_ringi = MagicMock()
            mock_msg_ringi.content = '{"title": "AI Tool", "executive_summary": "Great tool.", "risks": ["Risk 1"]}'

            mock_llm.invoke.side_effect = [mock_msg_fin, mock_msg_ringi]

            result = agent.run(mock_state)

            # Expectation: RingiSho and metrics populated
            assert isinstance(result, dict)
            assert "ringi_sho" in result
            assert "metrics_data" in result

            # Verify FileService call
            mock_file_service.save_text_async.assert_called_once()
            args, _ = mock_file_service.save_text_async.call_args
>           assert "# AI Tool" in args[0] # Verify content
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AssertionError: assert '# AI Tool' in '# Proposal for Untitled Idea\n\n**Status:** Rejected\n\n## Executive Summary\nAuto-generated summary failed.\n\n## Fi...n- **ROI:** 2.00x\n- **LTV:** $1000.00\n- **CAC:** $500.00\n- **Payback:** 10.0 months\n\n## Risks\n- Generation Error'

tests/unit/test_governance_agent.py:83: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    src.agents.governance:governance.py:102 Financial estimation failed. Using defaults.
Traceback (most recent call last):
  File "/app/src/agents/governance.py", line 99, in _estimate_financials
    estimates = self._safe_llm_call(prompt, FinancialEstimates)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/src/agents/governance.py", line 184, in _safe_llm_call
    data_dict = self._parse_json(content)
                ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/src/agents/governance.py", line 209, in _parse_json
    return json.loads(text) # type: ignore
           ^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/json/__init__.py", line 346, in loads
    return _default_decoder.decode(s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/json/decoder.py", line 338, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/json/decoder.py", line 356, in raw_decode
    raise JSONDecodeError("Expecting value", s, err.value) from None
json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)
ERROR    src.agents.governance:governance.py:144 Ringi-Sho generation failed. Using fallback.
Traceback (most recent call last):
  File "/app/src/agents/governance.py", line 134, in _generate_ringi_sho
    partial = self._safe_llm_call(prompt, PartialRingi)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/src/agents/governance.py", line 184, in _safe_llm_call
    data_dict = self._parse_json(content)
                ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/src/agents/governance.py", line 209, in _parse_json
    return json.loads(text) # type: ignore
           ^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/json/__init__.py", line 346, in loads
    return _default_decoder.decode(s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/json/decoder.py", line 338, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/json/decoder.py", line 356, in raw_decode
    raise JSONDecodeError("Expecting value", s, err.value) from None
json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.12-final-0 _______________

Name                                Stmts   Miss  Cover   Missing
-----------------------------------------------------------------
src/__init__.py                         0      0   100%
src/agents/__init__.py                  6      0   100%
src/agents/base.py                      9      0   100%
src/agents/builder.py                  95     10    89%   40-41, 48-49, 101, 130-131, 139-140, 181
src/agents/cpo.py                      45     11    76%   55-57, 74-81, 92-94
src/agents/governance.py              105      2    98%   200, 205
src/agents/ideator.py                  47     12    74%   31-34, 97-107
src/agents/mixins.py                   23      6    74%   28, 31-35
src/agents/personas.py                 79     10    87%   90-92, 97-98, 107-110, 158-163
src/core/__init__.py                    0      0   100%
src/core/config.py                    161      0   100%
src/core/constants.py                 100      0   100%
src/core/exceptions.py                  6      0   100%
src/core/factory.py                    42     19    55%   24-25, 30, 43-49, 57-68
src/core/graph.py                     149     32    79%   28-30, 49-55, 65-66, 104-108, 120-121, 147-148, 158-160, 163, 216-222, 230-239
src/core/llm.py                        10      0   100%
src/core/metrics.py                    17      0   100%
src/core/nemawashi/__init__.py          5      0   100%
src/core/nemawashi/analytics.py        52     22    58%   26, 33, 41-45, 55-56, 80-98, 102-107
src/core/nemawashi/consensus.py        76     10    87%   45-47, 50, 82, 115-116, 131, 142, 163
src/core/nemawashi/engine.py           19      1    95%   34
src/core/nemawashi/nomikai.py          42      2    95%   33-34
src/core/services/__init__.py           0      0   100%
src/core/services/file_service.py      31      5    84%   42-43, 49-51
src/core/simulation.py                 24      0   100%
src/core/theme.py                      18      0   100%
src/core/validators.py                 47     10    79%   47, 50-51, 53-54, 61, 64-65, 67-68
src/data/__init__.py                    2      0   100%
src/data/rag.py                       230     37    84%   63-64, 73-76, 98-99, 143-144, 153-154, 159-163, 201, 224-227, 236-238, 274, 278-279, 314-315, 332, 338-339, 398, 415-418
src/domain_models/__init__.py           8      0   100%
src/domain_models/common.py            23      0   100%
src/domain_models/enums.py             12      0   100%
src/domain_models/lean_canvas.py       24      0   100%
src/domain_models/metrics.py           60      6    90%   122-123, 127-128, 132-133
src/domain_models/mvp.py               54      4    93%   129-130, 138-139
src/domain_models/persona.py           28      2    93%   124-125
src/domain_models/politics.py          59      3    95%   77, 95, 106
src/domain_models/simulation.py        16      0   100%
src/domain_models/state.py             67      8    88%   76-77, 100-108
src/domain_models/transcript.py        22      2    91%   32-33
src/domain_models/validators.py        12      0   100%
src/tools/__init__.py                   3      0   100%
src/tools/search.py                    34      4    88%   39, 75, 90-91
src/tools/v0_client.py                 61     19    69%   58-60, 106-108, 111-118, 126-132
src/ui/renderer.py                     96     10    90%   87, 90-94, 118, 128-134, 154
-----------------------------------------------------------------
TOTAL                                2019    247    88%
=========================== short test summary info ============================
FAILED tests/unit/test_governance_agent.py::TestGovernanceAgent::test_run_populates_ringi_sho
======================== 1 failed, 135 passed in 19.04s ========================
